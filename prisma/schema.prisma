// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String   @id @default(uuid())
  email              String   @unique
  password           String
  name               String
  hashedRefreshToken String?
  role               Role     @default(RECEPTIONIST)
  isActive           Boolean  @default(true)
  doctorProfile      Doctor?
  patientProfile     Patient?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("users")
}

model Doctor {
  id             Int              @id @default(autoincrement())
  phone          String           @unique
  gender         Gender           @default(UNSPECIFIED)
  socialId       String?          @unique
  specialization String?
  licenseNumber  String?          @unique
  bio            String?
  userId         String           @unique
  user           User             @relation(fields: [userId], references: [id])
  appointments   Appointment[]
  schedules      DoctorSchedule[] // أوقات العمل

  @@map("doctors")
}

model Patient {
  id               Int               @id @default(autoincrement())
  phone            String            @unique
  email            String?
  dateOfBirth      DateTime?
  address          String?
  occupation       String?           @db.VarChar(255)
  weight           Decimal?          @db.Decimal(5, 2) // kg
  height           Decimal?          @db.Decimal(5, 2) // cm
  medicalHistory   String?           @db.Text
  emergencyContact String?           @db.VarChar(255)
  emergencyPhone   String?           @db.VarChar(20)
  appointments     Appointment[]
  examinations     Examination[]
  progressionNotes ProgressionNote[]
  treatmentPlans   TreatmentPlan[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  userId           String            @unique
  user             User              @relation(fields: [userId], references: [id])

  @@map("patients")
}

// ============= MEDICAL RECORD MODELS =============

model Examination {
  id                           Int      @id @default(autoincrement())
  patientId                    Int
  subjectivePainScale          Int?     @db.SmallInt // 0-10
  subjectiveLocation           String?  @db.VarChar(255)
  subjectiveDescription        String?  @db.Text
  subjectiveAggravatingFactors String?  @db.Text
  objectivePosture             String?  @db.VarChar(255)
  objectiveRegion              String?  @db.VarChar(255)
  objectivePhysiologicalMotion String?  @db.Text
  palpation                    String?  @db.Text
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Restrict)

  @@index([patientId, createdAt])
  @@map("examinations")
}

model ProgressionNote {
  id        Int      @id @default(autoincrement())
  patientId Int
  note      String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Restrict)

  @@index([patientId])
  @@map("progression_notes")
}

model TreatmentPlan {
  id          Int      @id @default(autoincrement())
  patientId   Int
  description String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Restrict)

  @@index([patientId])
  @@map("treatment_plans")
}

model Appointment {
  id              Int               @id @default(autoincrement())
  appointmentDate DateTime
  status          AppointmentStatus @default(PENDING)
  notes           String?

  doctorId  Int
  doctor    Doctor  @relation(fields: [doctorId], references: [id])
  patientId Int
  patient   Patient @relation(fields: [patientId], references: [id])

  medicalRecord MedicalRecord?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("appointments")
}

model DoctorSchedule {
  id        Int    @id @default(autoincrement())
  dayOfWeek Int // 0 (الأحد) إلى 6 (السبت)
  startTime String // مثال: "09:00"
  endTime   String // مثال: "17:00"
  doctorId  Int
  doctor    Doctor @relation(fields: [doctorId], references: [id])

  @@map("doctor_schedules")
}

model MedicalRecord {
  id            Int         @id @default(autoincrement())
  diagnosis     String      @db.Text
  prescription  String      @db.Text
  appointmentId Int         @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  createdAt     DateTime    @default(now())

  @@map("medical_records")
}

// ============= ENUMS =============

enum Gender {
  MALE
  FEMALE
  UNSPECIFIED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum Role {
  ADMIN
  DOCTOR
  RECEPTIONIST
  PATIENT
}
